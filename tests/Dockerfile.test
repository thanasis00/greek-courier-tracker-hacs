# Dockerfile for running Greek Courier Tracker tests
# Build context should be the project root (parent of tests/ directory)
# Using AMD64 image (works on ARM64 via emulation, already cached)

FROM --platform=linux/amd64 ghcr.io/home-assistant/amd64-base-python:3.12-alpine3.19

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apk add --no-cache gcc musl-dev libffi-dev

# Install Python dependencies
RUN pip install --no-cache-dir \
    pytest==8.3.4 \
    pytest-asyncio==0.24.0 \
    pytest-cov==6.0.0 \
    beautifulsoup4==4.12.3 \
    aiohttp==3.11.11 \
    async-timeout==4.0.3 \
    homeassistant

# Set PYTHONPATH to include the project root
ENV PYTHONPATH=/app

# Copy project files (build context is project root)
COPY custom_components/ custom_components/
COPY tests/ tests/
COPY tests/pytest.ini /app/pytest.ini

# Override s6-overlay entrypoint for testing
ENTRYPOINT ["/usr/local/bin/python"]

# Set default working directory for tests
WORKDIR /app
